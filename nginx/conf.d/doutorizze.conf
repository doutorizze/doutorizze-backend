# DOUTORIZZE - Configuração do Site
# Configuração específica para API e Frontend

# Redirecionamento HTTP para HTTPS
server {
    listen 80;
    server_name api.doutorizze.com doutorizze.com www.doutorizze.com;
    
    # Permitir Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # Redirecionamento para HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# API Backend
server {
    listen 443 ssl http2;
    server_name api.doutorizze.com;
    
    # Certificados SSL
    ssl_certificate /etc/nginx/ssl/api.doutorizze.com.crt;
    ssl_certificate_key /etc/nginx/ssl/api.doutorizze.com.key;
    
    # Logs específicos da API
    access_log /var/log/nginx/api_access.log main;
    error_log /var/log/nginx/api_error.log warn;
    
    # Rate limiting para API
    location /api/auth {
        limit_req zone=auth burst=10 nodelay;
        limit_req_status 429;
        
        proxy_pass http://doutorizze_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    location /api/parcelamais {
        limit_req zone=api burst=20 nodelay;
        limit_req_status 429;
        
        proxy_pass http://doutorizze_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    location /api/upload {
        limit_req zone=upload burst=5 nodelay;
        limit_req_status 429;
        
        client_max_body_size 10m;
        proxy_pass http://doutorizze_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    location /api {
        limit_req zone=api burst=20 nodelay;
        limit_req_status 429;
        
        proxy_pass http://doutorizze_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # Health check (sem rate limit)
    location /health {
        proxy_pass http://doutorizze_api/health;
        access_log off;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # Webhooks (sem rate limit para Parcelamais)
    location /api/webhooks/parcelamais {
        proxy_pass http://doutorizze_api;
        include /etc/nginx/conf.d/proxy_params.conf;
        
        # Permitir apenas IPs do Parcelamais (exemplo)
        # allow 192.168.1.0/24;
        # deny all;
    }
    
    # Bloquear acesso direto a arquivos sensíveis
    location ~ /\. {
        deny all;
    }
    
    location ~ \.(env|log|sql)$ {
        deny all;
    }
}

# Frontend
server {
    listen 443 ssl http2;
    server_name doutorizze.com www.doutorizze.com;
    
    # Certificados SSL
    ssl_certificate /etc/nginx/ssl/doutorizze.com.crt;
    ssl_certificate_key /etc/nginx/ssl/doutorizze.com.key;
    
    # Logs específicos do frontend
    access_log /var/log/nginx/frontend_access.log main;
    error_log /var/log/nginx/frontend_error.log warn;
    
    # Root para arquivos estáticos
    root /var/www/doutorizze;
    index index.html;
    
    # Configurações para SPA (Single Page Application)
    location / {
        try_files $uri $uri/ /index.html;
        
        # Cache para arquivos estáticos
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Vary Accept-Encoding;
        }
        
        # Sem cache para HTML
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }
    
    # Proxy para API (caso frontend e API estejam no mesmo domínio)
    location /api {
        proxy_pass http://doutorizze_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # Bloquear acesso a arquivos sensíveis
    location ~ /\. {
        deny all;
    }
    
    location ~ \.(env|log|sql|md)$ {
        deny all;
    }
}

# Servidor de desenvolvimento (opcional)
server {
    listen 80;
    server_name dev.doutorizze.com;
    
    # Logs de desenvolvimento
    access_log /var/log/nginx/dev_access.log main;
    error_log /var/log/nginx/dev_error.log warn;
    
    # Proxy para frontend de desenvolvimento
    location / {
        proxy_pass http://doutorizze_frontend;
        include /etc/nginx/conf.d/proxy_params.conf;
        
        # WebSocket para HMR (Hot Module Replacement)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # Proxy para API
    location /api {
        proxy_pass http://doutorizze_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
}

# Monitoramento (opcional)
server {
    listen 80;
    server_name monitor.doutorizze.com;
    
    # Autenticação básica
    auth_basic "DOUTORIZZE Monitoring";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    # Nginx status
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 172.20.0.0/16;
        deny all;
    }
    
    # Logs em tempo real
    location /logs {
        alias /var/log/nginx/;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
    }
    
    # Métricas da aplicação
    location /metrics {
        proxy_pass http://doutorizze_api/metrics;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
}